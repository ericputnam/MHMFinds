// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Support both local and production databases
  url      = env("DATABASE_URL")
}

// Subscription enums
enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  INCOMPLETE
  TRIALING
}

enum BillingInterval {
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String    @unique
  displayName   String?
  avatar        String?
  bio           String?
  isCreator     Boolean   @default(false)
  isPremium     Boolean   @default(false)
  isAdmin       Boolean   @default(false)
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  collections    Collection[]
  favorites      Favorite[]
  reviews        Review[]
  downloads      Download[]
  creatorProfile CreatorProfile?
  sessions       Session[]
  accounts       Account[]
  auditLogs      AdminAuditLog[]
  subscription   Subscription?
  downloadClicks DownloadClick[]
  submissions    ModSubmission[]
  notificationPreferences NotificationPreferences?
  notificationLogs NotificationLog[]

  @@index([email], name: "email_lookup")
  @@index([isCreator, isPremium], name: "user_tiers")
  @@map("users")
}

model CreatorProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  handle      String   @unique
  bio         String?
  website     String?
  socialLinks Json? // { twitter, instagram, youtube, etc. }
  isVerified  Boolean  @default(false)
  isFeatured  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  mods Mod[]

  @@map("creator_profiles")
}

model Category {
  id          String   @id @default(cuid())
  name        String // "Lamp", "House", "Build/Buy"
  slug        String // "lamp", "house", "build-buy" - can be same across different paths
  path        String   @unique // "cc/house/lamp" - materialized path for queries (unique)
  level       Int // 0 = root (CC), 1 = second level (House), etc.
  parentId    String? // Self-referential for tree structure
  description String?
  icon        String?
  order       Int      @default(0) // For sorting categories
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children Category[] @relation("CategoryTree")
  mods     Mod[]

  @@map("categories")
}

model Mod {
  id               String   @id @default(cuid())
  title            String
  description      String?
  shortDescription String?
  version          String?
  gameVersion      String? // Sims 4, Sims 3, etc.
  category         String // DEPRECATED: kept for migration, use facets
  categoryId       String? // DEPRECATED: use facets instead
  tags             String[] // DEPRECATED: use facets, kept for search fallback

  // ============================================
  // FACETED TAXONOMY - Multi-dimensional classification
  // ============================================

  // Content Type (single-select): What IS this mod?
  // Values: hair, tops, bottoms, dresses, full-body, shoes, accessories, jewelry,
  //         makeup, skin, eyes, nails, tattoos, furniture, lighting, decor, clutter,
  //         poses, gameplay-mod, script-mod, trait, career, lot, ui-preset
  contentType String?

  // Visual Style (single-select): What's the art style?
  // Values: alpha, maxis-match, semi-maxis, clayified, realistic
  visualStyle String?

  // Themes (multi-select): What's the vibe/aesthetic?
  // Values: christmas, halloween, valentines, easter, summer, fall, winter, spring,
  //         cottagecore, y2k, goth, boho, modern, vintage, fantasy, sci-fi,
  //         romantic, minimalist, preppy, grunge, dark-academia, kawaii, streetwear
  themes String[]

  // Age Groups (multi-select): Which sim ages?
  // Values: infant, toddler, child, teen, young-adult, adult, elder, all-ages
  ageGroups String[]

  // Gender/Frame (multi-select): Which body frames?
  // Values: masculine, feminine, unisex
  genderOptions String[]

  // Occult Types (multi-select): Special sim types?
  // Values: human, vampire, werewolf, mermaid, spellcaster, alien, ghost
  occultTypes String[]

  // Pack Requirements (multi-select): What packs needed?
  // Values: base-game, seasons, cottage-living, high-school-years, etc.
  packRequirements String[]
  thumbnail        String?
  images           String[] // Array of image URLs
  downloadUrl      String?
  sourceUrl        String? // Original source URL
  source           String // Patreon, CurseForge, Tumblr, etc.
  sourceId         String? // ID from source platform
  author           String? // Author/creator name from source
  isFree           Boolean   @default(true)
  price            Decimal?  @db.Decimal(10, 2)
  currency         String?   @default("USD")
  isNSFW           Boolean   @default(false)
  isVerified       Boolean   @default(false)
  isFeatured       Boolean   @default(false)
  downloadCount    Int       @default(0)
  viewCount        Int       @default(0)
  rating           Decimal?  @db.Decimal(3, 2)
  ratingCount      Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  publishedAt      DateTime?
  lastScraped      DateTime?

  // Relations
  creatorId      String?
  creator        CreatorProfile?  @relation(fields: [creatorId], references: [id])
  categoryRel    Category?        @relation(fields: [categoryId], references: [id])
  reviews        Review[]
  favorites      Favorite[]
  downloads      Download[]
  collections    CollectionItem[]
  modFiles       ModFile[]
  searchIndex    SearchIndex?
  downloadClicks DownloadClick[]
  submissions    ModSubmission[]
  monetizationOpportunities MonetizationOpportunity[]

  // Performance indexes for high-traffic queries
  @@index([isVerified, isNSFW, createdAt(sort: Desc)], name: "verified_safe_newest")
  @@index([isVerified, isNSFW, downloadCount(sort: Desc)], name: "verified_safe_popular")
  @@index([isVerified, isNSFW, rating(sort: Desc)], name: "verified_safe_rated")
  @@index([categoryId, isVerified, createdAt(sort: Desc)], name: "category_verified_newest")
  @@index([creatorId, publishedAt(sort: Desc)], name: "creator_mods")
  @@index([source, sourceId], name: "source_lookup")
  @@index([isFeatured, publishedAt], name: "featured_mods")
  @@index([category], name: "legacy_category")
  // Facet indexes for filtering
  @@index([contentType, isVerified, createdAt(sort: Desc)], name: "facet_content_type")
  @@index([visualStyle, isVerified], name: "facet_visual_style")
  @@map("mods")
}

// ============================================
// FACET DEFINITIONS - UI metadata for faceted navigation
// ============================================

model FacetDefinition {
  id          String   @id @default(cuid())
  facetType   String // "contentType", "visualStyle", "themes", etc.
  value       String // "hair", "alpha", "christmas", etc.
  displayName String // "Hair", "Alpha CC", "Christmas"
  description String? // Optional help text
  icon        String? // Emoji or icon name
  color       String? // Hex color for UI badges
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([facetType, value])
  @@index([facetType, isActive, sortOrder], name: "facet_lookup")
  @@map("facet_definitions")
}

model ModFile {
  id          String   @id @default(cuid())
  modId       String
  filename    String
  fileSize    Int // in bytes
  downloadUrl String
  version     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Relations
  mod Mod @relation(fields: [modId], references: [id], onDelete: Cascade)

  @@map("mod_files")
}

model Collection {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  isPublic    Boolean  @default(true)
  isFeatured  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CollectionItem[]

  @@index([userId, isPublic], name: "user_collections")
  @@index([isFeatured, updatedAt(sort: Desc)], name: "featured_collections")
  @@map("collections")
}

model CollectionItem {
  id           String   @id @default(cuid())
  collectionId String
  modId        String
  addedAt      DateTime @default(now())
  notes        String?

  // Relations
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  mod        Mod        @relation(fields: [modId], references: [id], onDelete: Cascade)

  @@unique([collectionId, modId])
  @@map("collection_items")
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  modId     String
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  mod  Mod  @relation(fields: [modId], references: [id], onDelete: Cascade)

  @@unique([userId, modId])
  @@index([userId, createdAt(sort: Desc)], name: "user_favorites")
  @@index([modId, createdAt], name: "mod_favorites_count")
  @@map("favorites")
}

model Review {
  id         String   @id @default(cuid())
  userId     String
  modId      String
  rating     Int // 1-5 stars
  comment    String?
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  mod  Mod  @relation(fields: [modId], references: [id], onDelete: Cascade)

  @@unique([userId, modId])
  @@index([modId, createdAt(sort: Desc)], name: "mod_reviews")
  @@index([userId, createdAt(sort: Desc)], name: "user_reviews")
  @@index([rating, createdAt], name: "rating_timeline")
  @@map("reviews")
}

model Download {
  id        String   @id @default(cuid())
  userId    String
  modId     String
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  mod  Mod  @relation(fields: [modId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)], name: "user_downloads")
  @@index([modId, createdAt(sort: Desc)], name: "mod_downloads_count")
  @@index([createdAt], name: "download_timeline")
  @@map("downloads")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model ContentSource {
  id             String    @id @default(cuid())
  name           String    @unique // Patreon, CurseForge, Tumblr, etc.
  baseUrl        String
  apiEndpoint    String?
  apiKey         String?
  isActive       Boolean   @default(true)
  lastScraped    DateTime?
  scrapeInterval Int       @default(3600) // seconds
  rateLimit      Int       @default(100) // requests per hour
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  scrapingJobs ScrapingJob[]

  @@map("content_sources")
}

model ScrapingJob {
  id             String    @id @default(cuid())
  sourceId       String
  status         String // pending, running, completed, failed
  startedAt      DateTime?
  completedAt    DateTime?
  error          String?
  itemsFound     Int       @default(0)
  itemsProcessed Int       @default(0)
  createdAt      DateTime  @default(now())

  // Relations
  source ContentSource @relation(fields: [sourceId], references: [id])

  @@map("scraping_jobs")
}

model SearchIndex {
  id           String   @id @default(cuid())
  modId        String   @unique
  searchVector String   @db.Text // Full-text search vector
  embedding    Float[] // Vector embedding for AI search
  lastIndexed  DateTime @default(now())

  // Relations
  mod Mod @relation(fields: [modId], references: [id], onDelete: Cascade)

  @@index([lastIndexed], name: "reindex_tracking")
  @@map("search_index")
}

model ModSubmission {
  id String @id @default(cuid())

  // Original fields (for anonymous submissions)
  modUrl         String
  modName        String
  description    String  @db.Text
  category       String
  submitterName  String
  submitterEmail String
  submitterIp    String?

  // Creator submission fields (all optional for backward compatibility)
  userId           String?
  shortDescription String?
  version          String?
  gameVersion      String?
  tags             String[]
  thumbnail        String?
  images           String[]
  downloadUrl      String?
  sourceUrl        String?
  source           String?  @default("Creator Upload")
  author           String?
  isFree           Boolean  @default(true)
  price            Decimal? @db.Decimal(10, 2)
  currency         String?  @default("USD")
  isNSFW           Boolean  @default(false)

  // Track approved mod for edit workflow
  approvedModId String?
  isEdit        Boolean @default(false)

  // Status tracking
  status      String    @default("pending") // pending, approved, rejected
  reviewedAt  DateTime?
  reviewedBy  String?
  reviewNotes String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user        User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  approvedMod Mod?  @relation(fields: [approvedModId], references: [id], onDelete: SetNull)

  @@index([status, createdAt(sort: Desc)], name: "pending_submissions")
  @@index([submitterEmail], name: "submission_tracking")
  @@index([userId, status], name: "creator_submissions")
  @@index([approvedModId], name: "mod_edits")
  @@map("mod_submissions")
}

model AdminAuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String // create, update, delete, approve, reject, etc.
  resource   String // mod, user, submission, etc.
  resourceId String?
  details    Json? // Additional context about the action
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)], name: "user_audit_log")
  @@index([resource, resourceId], name: "resource_audit_log")
  @@index([createdAt(sort: Desc)], name: "recent_actions")
  @@map("admin_audit_logs")
}

model Waitlist {
  id        String   @id @default(cuid())
  email     String   @unique
  source    String   @default("sign-in") // sign-in, footer, popup, etc.
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  notified  Boolean  @default(false) // Track if we've sent launch notification

  @@index([createdAt(sort: Desc)], name: "recent_signups")
  @@index([notified], name: "notification_status")
  @@map("waitlist")
}

// Subscription and Payment Models
model Subscription {
  id              String             @id @default(cuid())
  userId          String             @unique
  isPremium       Boolean            @default(false)
  status          SubscriptionStatus @default(ACTIVE)
  billingInterval BillingInterval?

  // Stripe fields
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  // LIFETIME usage tracking (not monthly reset)
  lifetimeClicksUsed Int @default(0)
  clickLimit         Int @default(5)

  startedAt         DateTime  @default(now())
  canceledAt        DateTime?
  cancelAtPeriodEnd Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  clickHistory DownloadClick[]
  invoices     Invoice[]

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([status])
  @@map("subscriptions")
}

model DownloadClick {
  id             String   @id @default(cuid())
  userId         String
  modId          String
  subscriptionId String
  ipAddress      String?
  userAgent      String?
  referrer       String?
  clickedAt      DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  mod          Mod          @relation(fields: [modId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([userId, clickedAt])
  @@index([modId])
  @@map("download_clicks")
}

model Invoice {
  id               String    @id @default(cuid())
  subscriptionId   String
  stripeInvoiceId  String    @unique
  amountPaid       Decimal   @db.Decimal(10, 2)
  currency         String    @default("USD")
  status           String
  hostedInvoiceUrl String?
  invoicePdf       String?
  periodStart      DateTime
  periodEnd        DateTime
  paidAt           DateTime?
  createdAt        DateTime  @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@map("invoices")
}

// Analytics Event Types
enum AnalyticsEventType {
  PAGE_VIEW
  SEARCH
  DOWNLOAD_CLICK
  AD_VIEW
  AD_CLICK
  MOD_VIEW
  FAVORITE_ADD
  FAVORITE_REMOVE
  COLLECTION_ADD
}

model AnalyticsEvent {
  id        String             @id @default(cuid())
  eventType AnalyticsEventType

  // User tracking (optional for anonymous events)
  userId    String?
  sessionId String? // Track anonymous sessions

  // Event metadata
  page        String? // Page URL/path
  referrer    String?
  searchQuery String?
  modId       String?
  categoryId  String?
  adId        String?

  // Engagement metrics
  timeOnPage  Int? // Seconds spent on page
  scrollDepth Int? // Percentage scrolled (0-100)

  // Technical metadata
  ipAddress  String?
  userAgent  String?
  deviceType String? // mobile, tablet, desktop
  browser    String?
  os         String?
  country    String?

  // Additional data (flexible JSON for future extensions)
  metadata Json?

  createdAt DateTime @default(now())

  // Indexes for fast analytics queries
  @@index([eventType, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([sessionId, createdAt(sort: Desc)])
  @@index([modId, eventType])
  @@index([searchQuery])
  @@index([page, createdAt])
  @@index([createdAt(sort: Desc)])
  @@map("analytics_events")
}

// ============================================
// MONETIZATION AGENT MODELS
// ============================================

// Enum for opportunity types
enum OpportunityType {
  AFFILIATE_PLACEMENT
  AD_LAYOUT_OPTIMIZATION
  CONTENT_EXPANSION
  TRAFFIC_SOURCE_OPTIMIZATION
  SEASONAL_CAMPAIGN
}

// Enum for opportunity status
enum OpportunityStatus {
  PENDING
  APPROVED
  REJECTED
  IMPLEMENTED
  EXPIRED
}

// Enum for action types
enum ActionType {
  ADD_AFFILIATE_LINK
  UPDATE_META_DESCRIPTION
  ADD_TO_COLLECTION
  UPDATE_AD_PLACEMENT
  EXPAND_CONTENT
  OPTIMIZE_SEO
  CREATE_COLLECTION
  AB_TEST
  TRAFFIC_REDIRECT
  GENERATE_INTERNAL_LINKS
}

// Enum for action status
enum ActionStatus {
  PENDING
  APPROVED
  REJECTED
  EXECUTED
  FAILED
  ROLLED_BACK
}

// Enum for agent run types
enum AgentRunType {
  FULL
  GA4_SYNC
  MEDIAVINE_SYNC
  AFFILIATE_SCAN
  RPM_ANALYSIS
  FORECAST
  CLEANUP
}

// Enum for agent run status
enum AgentRunStatus {
  RUNNING
  COMPLETED
  FAILED
}

// Daily metrics snapshot per page
model MonetizationMetric {
  id         String   @id @default(cuid())
  metricDate DateTime @db.Date
  pageUrl    String
  pageType   String? // mod, category, search, home, blog

  // Traffic metrics
  pageviews      Int     @default(0)
  uniqueVisitors Int     @default(0)
  bounceRate     Decimal @default(0) @db.Decimal(5, 2) // 0-100%
  avgTimeOnPage  Int     @default(0) // seconds
  scrollDepth    Decimal @default(0) @db.Decimal(5, 2) // 0-100%

  // Traffic source breakdown
  trafficGoogle   Int @default(0)
  trafficPinterest Int @default(0)
  trafficDirect   Int @default(0)
  trafficSocial   Int @default(0)
  trafficOther    Int @default(0)

  // Ad revenue metrics
  adImpressions Int     @default(0)
  adRevenue     Decimal @default(0) @db.Decimal(10, 2)
  rpm           Decimal @default(0) @db.Decimal(10, 4) // Revenue per mille

  // Affiliate metrics
  affiliateClicks      Int     @default(0)
  affiliateConversions Int     @default(0)
  affiliateRevenue     Decimal @default(0) @db.Decimal(10, 2)

  // Engagement metrics
  modDownloads  Int @default(0)
  modFavorites  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([pageUrl, metricDate])
  @@index([metricDate(sort: Desc)])
  @@index([pageType, metricDate])
  @@index([pageUrl])
  @@map("monetization_metrics")
}

// Detected monetization opportunity
model MonetizationOpportunity {
  id              String            @id @default(cuid())
  opportunityType OpportunityType
  title           String
  description     String            @db.Text
  status          OpportunityStatus @default(PENDING)

  // Classification
  priority   Int     @default(5) // 1-10, 10 being highest
  confidence Decimal @db.Decimal(3, 2) // 0-1

  // Context
  pageUrl  String?
  modId    String?
  category String?

  // Impact estimation
  estimatedRevenueImpact Decimal? @db.Decimal(10, 2)
  estimatedRpmIncrease   Decimal? @db.Decimal(5, 2) // percentage

  // Approval tracking
  approvedAt   DateTime?
  approvedBy   String?
  rejectedAt   DateTime?
  rejectedBy   String?
  rejectionReason String?

  // Execution tracking
  implementedAt DateTime?
  expiresAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  mod     Mod?                  @relation(fields: [modId], references: [id], onDelete: SetNull)
  actions MonetizationAction[]

  @@index([status, priority(sort: Desc)])
  @@index([opportunityType, status])
  @@index([modId])
  @@index([createdAt(sort: Desc)])
  @@map("monetization_opportunities")
}

// Specific action to take for an opportunity
model MonetizationAction {
  id            String       @id @default(cuid())
  opportunityId String
  actionType    ActionType
  actionData    Json // Specific data for the action (e.g., affiliate URL, ad placement config)
  status        ActionStatus @default(PENDING)

  // Execution details
  approvedAt    DateTime?
  approvedBy    String?
  rejectedAt    DateTime?
  rejectedBy    String?
  executedAt    DateTime?
  rolledBackAt  DateTime?

  // Auto-execution fields (PRD-18)
  autoExecutable     Boolean   @default(false)
  executionTier      Int       @default(3) // 1=auto, 2=after-approval, 3=manual
  executionResult    Json?     // { success: boolean, output: string, error?: string }
  executionAttempts  Int       @default(0)
  lastAttemptAt      DateTime?
  rateLimitKey       String?   // e.g., "mod:123" to limit per-entity

  // Impact measurement
  preExecutionMetrics  Json? // Snapshot before execution
  postExecutionMetrics Json? // Snapshot after execution
  measuredImpact       Decimal? @db.Decimal(10, 2)

  // Learning fields (PRD-20)
  verifiedImpact     Decimal?   @db.Decimal(10, 2)
  verifiedAt         DateTime?
  learningApplied    Boolean    @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  opportunity        MonetizationOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  executionLogs      ExecutionLog[]
  impactMeasurements ImpactMeasurement[]

  @@index([status])
  @@index([opportunityId])
  @@index([executionTier, status])
  @@map("monetization_actions")
}

// Monthly revenue forecast
model RevenueForecast {
  id          String   @id @default(cuid())
  forecastMonth DateTime @db.Date // First day of the month

  // Forecasted values
  forecastedAdRevenue        Decimal @db.Decimal(10, 2)
  forecastedAffiliateRevenue Decimal @db.Decimal(10, 2)
  forecastedMembershipRevenue Decimal @default(0) @db.Decimal(10, 2)
  forecastedTotalRevenue     Decimal @db.Decimal(10, 2)

  // Actual values (filled in as month progresses)
  actualAdRevenue        Decimal? @db.Decimal(10, 2)
  actualAffiliateRevenue Decimal? @db.Decimal(10, 2)
  actualMembershipRevenue Decimal? @db.Decimal(10, 2)
  actualTotalRevenue     Decimal? @db.Decimal(10, 2)

  // Growth metrics
  monthOverMonthGrowth Decimal? @db.Decimal(5, 2) // percentage
  yearOverYearGrowth   Decimal? @db.Decimal(5, 2) // percentage
  growthRate           Decimal? @db.Decimal(5, 4) // monthly growth rate

  // Model metadata
  confidenceLevel   Decimal @db.Decimal(3, 2) // 0-1
  modelVersion      String  @default("v1")
  inputDataSnapshot Json? // Snapshot of input data used

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([forecastMonth])
  @@index([forecastMonth(sort: Desc)])
  @@map("revenue_forecasts")
}

// Agent execution log
model AgentRun {
  id        String         @id @default(cuid())
  runType   AgentRunType
  status    AgentRunStatus @default(RUNNING)

  // Timing
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  durationMs  Int?

  // Metrics
  itemsProcessed      Int @default(0)
  opportunitiesFound  Int @default(0)
  errorsEncountered   Int @default(0)

  // Logs
  logSummary   String? @db.Text
  errorDetails Json?

  createdAt DateTime @default(now())

  @@index([runType, startedAt(sort: Desc)])
  @@index([status])
  @@map("agent_runs")
}

// ============================================
// AUTO-EXECUTION ENGINE (PRD-18)
// ============================================

// Execution log for tracking action executions
model ExecutionLog {
  id              String   @id @default(cuid())
  actionId        String
  action          MonetizationAction @relation(fields: [actionId], references: [id], onDelete: Cascade)

  executedAt      DateTime @default(now())
  executedBy      String   // "auto" | "approved" | userId

  // Execution details
  inputData       Json
  outputData      Json?

  success         Boolean
  errorMessage    String?
  durationMs      Int

  // Rollback info
  rollbackData    Json?    // Data needed to undo this action
  rolledBackAt    DateTime?
  rolledBackBy    String?

  @@index([actionId])
  @@index([executedAt(sort: Desc)])
  @@index([success, executedAt])
  @@map("execution_logs")
}

// ============================================
// NOTIFICATIONS SYSTEM (PRD-19)
// ============================================

// User notification preferences
model NotificationPreferences {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Channel settings
  slackEnabled    Boolean  @default(true)
  emailEnabled    Boolean  @default(true)
  slackWebhook    String?  // User-specific webhook if different from global

  // Notification types
  criticalAlerts    Boolean @default(true)
  opportunityAlerts Boolean @default(true)
  executionAlerts   Boolean @default(true)
  digestAlerts      Boolean @default(true)

  // Thresholds
  minImpactForAlert Decimal @default(10) @db.Decimal(10, 2) // Only alert if impact > $X/month

  // Quiet hours (no notifications)
  quietHoursStart Int?     // Hour of day (0-23)
  quietHoursEnd   Int?
  timezone        String   @default("America/New_York")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("notification_preferences")
}

// Notification log for audit trail
model NotificationLog {
  id              String   @id @default(cuid())
  type            String   // critical, standard, digest
  channel         String   // slack, email
  event           String   // opportunity_detected, run_failed, etc.

  recipientId     String?
  recipient       User?    @relation(fields: [recipientId], references: [id], onDelete: SetNull)

  subject         String
  body            String   @db.Text
  metadata        Json?

  sentAt          DateTime @default(now())
  success         Boolean
  errorMessage    String?

  @@index([type, sentAt(sort: Desc)])
  @@index([recipientId, sentAt(sort: Desc)])
  @@index([event, sentAt(sort: Desc)])
  @@map("notification_logs")
}

// ============================================
// IMPACT TRACKING & LEARNING (PRD-20)
// ============================================

// Impact measurement for executed actions
model ImpactMeasurement {
  id              String   @id @default(cuid())

  // Link to action
  actionId        String
  action          MonetizationAction @relation(fields: [actionId], references: [id], onDelete: Cascade)

  // Measurement metadata
  measurementType String   // revenue, traffic, rpm, conversion
  measurementWindow Int    // Days measured
  startDate       DateTime
  endDate         DateTime

  // Baseline data (before action)
  baselineValue   Decimal  @db.Decimal(10, 4)
  baselinePeriodStart DateTime
  baselinePeriodEnd DateTime

  // Measured data (after action)
  measuredValue   Decimal  @db.Decimal(10, 4)

  // Calculated impact
  absoluteImpact  Decimal  @db.Decimal(10, 4) // measuredValue - baselineValue
  percentImpact   Decimal  @db.Decimal(10, 4) // (absoluteImpact / baselineValue) * 100
  revenueImpact   Decimal? @db.Decimal(10, 2) // Estimated monthly $ impact

  // Comparison to prediction
  estimatedImpact Decimal  @db.Decimal(10, 2) // Original prediction
  predictionError Decimal  @db.Decimal(10, 4) // Percentage error
  predictionAccuracy Decimal @db.Decimal(5, 4) // 1 - abs(error), capped at 0

  // Attribution
  attributionConfidence Decimal @db.Decimal(5, 4) // How confident are we this was due to the action
  attributionNotes String?

  // Status
  status          String   @default("pending") // pending, measuring, complete, inconclusive
  completedAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([actionId])
  @@index([status])
  @@index([endDate])
  @@map("impact_measurements")
}

// ============================================
// AFFILIATE OFFERS SYSTEM
// ============================================

model AffiliateOffer {
  id          String   @id @default(cuid())
  name        String   // "Razer BlackWidow V4 Keyboard"
  description String?  // Short promo text
  imageUrl    String   // Product image
  affiliateUrl String  // Impact.com tracking link

  // Partner/brand info
  partner     String   // "razer", "corsair", "green-man-gaming"
  partnerLogo String?  // Partner brand logo URL

  // Categorization
  category    String   // "peripherals", "gaming-chairs", "games", "pc-components"

  // Display settings
  priority    Int      @default(0)  // Higher = shown first
  isActive    Boolean  @default(true)

  // Promotional info
  promoText   String?  // "20% OFF" or "Free Shipping"
  promoColor  String?  // Hex color for promo badge

  // Scheduling
  startDate   DateTime?
  endDate     DateTime?

  // Performance tracking
  impressions Int      @default(0)
  clicks      Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  clickEvents AffiliateClick[]

  @@index([isActive, priority(sort: Desc)])
  @@index([category, isActive])
  @@index([partner])
  @@map("affiliate_offers")
}

model AffiliateClick {
  id          String   @id @default(cuid())
  offerId     String

  // Context
  sourceType  String   // "interstitial", "grid", "sidebar"
  modId       String?  // Which mod page triggered this (if any)
  pageUrl     String?

  // User tracking
  sessionId   String?
  ipAddress   String?
  userAgent   String?

  clickedAt   DateTime @default(now())

  // Relations
  offer       AffiliateOffer @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([offerId, clickedAt(sort: Desc)])
  @@index([sourceType, clickedAt])
  @@map("affiliate_clicks")
}

// Aggregate learning metrics for prediction accuracy tracking
model AgentLearningMetric {
  id              String   @id @default(cuid())

  // What this metric tracks
  metricType      String   // prediction_accuracy, execution_success, etc.
  actionType      String?  // If specific to an action type
  opportunityType String?  // If specific to opportunity type

  // Time period
  periodStart     DateTime
  periodEnd       DateTime
  periodType      String   // daily, weekly, monthly

  // Values
  sampleSize      Int
  meanValue       Decimal  @db.Decimal(10, 4)
  medianValue     Decimal? @db.Decimal(10, 4)
  stdDeviation    Decimal? @db.Decimal(10, 4)
  minValue        Decimal? @db.Decimal(10, 4)
  maxValue        Decimal? @db.Decimal(10, 4)

  // Trending
  previousPeriodValue Decimal? @db.Decimal(10, 4)
  trend           Decimal? @db.Decimal(10, 4) // Percentage change from previous

  createdAt       DateTime @default(now())

  @@unique([metricType, actionType, opportunityType, periodStart, periodType])
  @@index([metricType, periodStart(sort: Desc)])
  @@map("agent_learning_metrics")
}
