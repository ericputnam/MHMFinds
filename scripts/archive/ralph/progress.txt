## Codebase Patterns

### Admin API Authentication
```typescript
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/authOptions';

const session = await getServerSession(authOptions);
if (!session?.user?.isAdmin) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}
```

### Prisma Client Import
```typescript
import { prisma } from '@/lib/prisma';
```

### Facet Types
- contentType: single-select (String?)
- visualStyle: single-select (String?)
- themes: multi-select (String[])

### FacetDefinition facetType values
- "contentType"
- "visualStyle"
- "themes"

### Optimistic Updates Pattern (React)
```typescript
// Update local state immediately
setItems(prev => prev.map(item =>
  item.id === id ? { ...item, ...updates } : item
));

// Then call API
const response = await fetch(...);
if (!response.ok) {
  // Revert on failure
  setItems(prev => prev.map(item =>
    item.id === id ? originalItem : item
  ));
}
```

---

# Progress Log

## 2026-01-22: All Stories Completed ✅

### FACET-001: Facet Definitions API ✅
- `GET /api/admin/facets` - Lists all facets grouped by type with mod counts
- `POST /api/admin/facets` - Creates new facet definition
- `PATCH /api/admin/facets/[id]` - Updates facet definition
- `DELETE /api/admin/facets/[id]` - Deletes (only if unused)
- All endpoints require admin auth

### FACET-002: Categories Page Repurposed ✅
- `app/admin/categories/page.tsx` now manages FacetDefinitions
- Tabs for: contentType, visualStyle, themes, ageGroups, genderOptions, occultTypes, packRequirements
- Shows value, displayName, icon, color, sortOrder, isActive, modCount
- Add/edit/delete modals with all fields
- Toggle for isActive status

### FACET-003: Mod Edit Form Updated ✅
- `app/admin/mods/[id]/edit/page.tsx` includes all facet fields
- Single-select dropdowns for contentType and visualStyle
- Multi-select chip pickers for themes, ageGroups, genderOptions, occultTypes, packRequirements
- Facet options fetched from API on page load
- Values saved with form submission

### FACET-004: Mods List Updated ✅
- `app/admin/mods/page.tsx` shows facet columns in table
- Filter dropdowns for contentType, visualStyle, themes
- "Missing Facets" checkbox filter shows mods with null contentType
- API at `app/api/admin/mods/route.ts` supports facet filtering

### FACET-005: Bulk Facet Edit Modal ✅
- "Edit Facets" button appears when mods are selected
- Modal with contentType, visualStyle, themes controls
- Each field has modes: No Change, Set To, Clear
- Themes has additional "Add" mode for merging
- Preview section shows what will change
- Count of selected mods shown in header

### FACET-006: Bulk Facet Update API ✅
- `PATCH /api/admin/mods/bulk-facets`
- Accepts modIds array and facet update instructions
- Handles set, add, clear modes for themes
- Returns count of updated mods
- Logs operations for audit trail

### FACET-007: Quick Facet Actions ✅
- Clickable facet badges in mods table open quick-edit popovers
- Popovers for contentType and visualStyle show dropdown options
- Themes popover shows checkbox list for toggle
- Optimistic updates with revert on error
- Uses handleQuickEdit function for API calls

### FACET-008: Seed Script ✅
- `scripts/seed-facet-definitions.ts` with 100+ facet values
- Content types: CAS items, furniture, gameplay mods, etc.
- Visual styles: alpha, maxis-match, semi-maxis, clayified, realistic
- Themes: seasonal, aesthetics (cottagecore, goth, y2k, etc.)
- Age groups, gender options, occult types, pack requirements
- npm script: `npm run db:seed:facets`

### FACET-009: Admin Navigation Updated ✅
- `app/admin/layout.tsx` nav item renamed to "Taxonomy"
- Uses Tags icon (lucide-react)
- Still points to /admin/categories

### FACET-010: Integration Testing ✅
- `npm run type-check` passes
- `npm run build` succeeds
- All features functional
