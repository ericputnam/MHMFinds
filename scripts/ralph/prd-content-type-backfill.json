{
  "projectName": "Content Type Backfill & Recategorization",
  "branchName": "feat/content-type-backfill",
  "description": "Analyze and correctly categorize all existing mods in the database. Create missing FacetDefinitions, fix miscategorized mods, and validate that content types match actual mod content based on title and description analysis.",
  "context": {
    "contentTypeStrategy": "Granular content types (eyebrows as own type, not under makeup)",
    "roomStrategy": "Use themes array for room tags (bathroom, kitchen, bedroom) alongside contentType for object type (furniture, decor)",
    "facetCreation": "Auto-create FacetDefinitions with sensible defaults when new categories are needed",
    "validationCriteria": "Title and description keywords must logically match the assigned contentType"
  },
  "userStories": [
    {
      "id": "CTB-001",
      "title": "Audit current content type distribution",
      "description": "Create a comprehensive audit of all content types currently in use, identify mismatches, and document patterns",
      "acceptanceCriteria": [
        "Create scripts/ralph/ctb-001-audit.ts script",
        "Query all unique contentType values and their counts",
        "Identify mods with NULL contentType",
        "Identify content types in use WITHOUT FacetDefinitions (pet-furniture, cas-background, loading-screen, preset)",
        "Sample 20 mods from each contentType and log title + contentType for review",
        "Output audit report to scripts/ralph/ctb-audit-report.txt",
        "npm run type-check passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Completed 2026-01-24. Found 31 unique content types, 45 NULL, 4 orphaned (preset, loading-screen, cas-background, pet-furniture)"
    },
    {
      "id": "CTB-002",
      "title": "Create missing FacetDefinitions",
      "description": "Auto-create FacetDefinition entries for content types that exist in mods but lack definitions",
      "acceptanceCriteria": [
        "Create scripts/ralph/ctb-002-create-facets.ts script",
        "Create FacetDefinitions for: pet-furniture, cas-background, loading-screen, preset",
        "Create FacetDefinitions for new granular types: eyebrows, lashes, eyeliner, blush, lipstick, beard, facial-hair",
        "Create FacetDefinitions for room themes: bathroom, kitchen, bedroom, living-room, dining-room, outdoor, office, kids-room, nursery",
        "Use upsert to avoid duplicates",
        "Set sensible displayName, sortOrder, and isActive=true",
        "Log created definitions",
        "npm run type-check passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Completed 2026-01-24. Created 20 FacetDefinitions: 4 orphaned content types (preset, loading-screen, cas-background, pet-furniture), 7 granular face types (eyebrows, lashes, eyeliner, blush, lipstick, beard, facial-hair), 9 room themes (bathroom, kitchen, bedroom, living-room, dining-room, outdoor, office, kids-room, nursery). Room themes use facetType='themes'."
    },
    {
      "id": "CTB-003",
      "title": "Build intelligent content type detection function",
      "description": "Create a robust content type detection function that analyzes title and description to determine the most accurate content type",
      "acceptanceCriteria": [
        "Create lib/services/contentTypeDetector.ts",
        "Export detectContentType(title: string, description?: string): string | undefined",
        "Export detectRoomThemes(title: string, description?: string): string[]",
        "Handle granular face categories: eyebrows, lashes, eyeliner, blush, lipstick, beard, facial-hair",
        "Handle CAS items: cas-background, preset, loading-screen",
        "Handle pet items: pet-furniture, pet-clothing, pet-accessories",
        "Handle build/buy: furniture, decor, clutter, lighting, plants, rugs, curtains, wall-art",
        "Include confidence scoring (high/medium/low based on keyword matches)",
        "Return undefined for ambiguous cases rather than guessing",
        "npm run type-check passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Completed 2026-01-24. Created lib/services/contentTypeDetector.ts with priority-based keyword detection system. Features: detectContentType() and detectRoomThemes() functions, DetectionResult and RoomThemeResult types with confidence scoring (high/medium/low), negative keyword support to prevent false matches, batch processing utilities, and validation helpers. Supports 35+ content types across granular face categories, CAS items, pet items, build/buy, clothing, and mods."
    },
    {
      "id": "CTB-004",
      "title": "Create content type test suite",
      "description": "Build comprehensive tests that verify content type detection works correctly for known examples",
      "acceptanceCriteria": [
        "Create scripts/ralph/ctb-004-detection-tests.ts",
        "Test cases for hair variations: ponytail, braids, updo, bangs, bob, pixie, afro",
        "Test cases for face: eyebrows, eyelashes, lashes, eyeliner, lipstick, blush, beard, mustache",
        "Test cases for clothing: tops, bottoms, dresses, full-body, shoes, accessories",
        "Test cases for furniture with room context: 'bathroom sink' -> furniture + [bathroom]",
        "Test cases for room packs: 'Kitchen CC Pack' -> furniture + [kitchen]",
        "Test ambiguous cases that should return undefined",
        "All tests must pass with at least 90% accuracy",
        "Output test results to scripts/ralph/ctb-detection-test-results.txt",
        "npm run type-check passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Completed 2026-01-24. Created comprehensive test suite with 149 test cases across 20 categories. Achieved 95.30% accuracy (142/149 passing), exceeding the 90% target. Categories tested: Hair Variations (10), Face - Eyebrows/Lashes/Eyeliner/Lipstick/Blush/Beard/Mustache (22), Clothing - Tops/Bottoms/Dresses/Full Body/Shoes (31), Accessories/Jewelry/Glasses/Hats (16), Furniture + Room (8), Room Packs (5), Decor (12), CAS Special (5), Pet Items (8), Skin/Tattoos (6), Eyes/Nails (4), Makeup (4), Mods (4), Ambiguous (6), Edge Cases (5). 7 edge cases failed involving uncommon patterns (island, patio, highlighter). Results output to ctb-detection-test-results.txt."
    },
    {
      "id": "CTB-005",
      "title": "Fix eyebrow/lash mods miscategorized as skin/hair",
      "description": "Identify and fix mods with 'eyebrow' or 'lash' in title that are incorrectly categorized",
      "acceptanceCriteria": [
        "Create scripts/ralph/ctb-005-fix-face-details.ts",
        "Find all mods with 'eyebrow' in title not categorized as 'eyebrows'",
        "Find all mods with 'lash' or 'eyelash' in title not categorized as 'lashes'",
        "Find all mods with 'eyeliner' in title not categorized as 'eyeliner' or 'makeup'",
        "Find all mods with 'lipstick' or 'lip' in title not categorized as 'lipstick' or 'makeup'",
        "Find all mods with 'blush' in title not categorized as 'blush' or 'makeup'",
        "Find all mods with 'beard' or 'mustache' or 'facial hair' in title",
        "Dry run first logging all changes",
        "Apply fixes with --fix flag",
        "Log all changes made",
        "npm run type-check passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Completed 2026-01-24. Created scripts/ralph/ctb-005-fix-face-details.ts with keyword-based detection and negative keyword filtering (to avoid false positives like 'splash', 'slasher', 'whiplash'). Fixed 221 miscategorized mods: 127 eyebrows (from eyes/makeup/hair/skin/full-body/lot), 18 lashes (from makeup/eyes), 7 eyeliner (from hair/full-body/dresses/tops/accessories), 7 lipstick (from tops/hair/full-body), 4 blush (from tops/skin), 35 beard (from hair/accessories/tops/full-body), 23 facial-hair (from hair/skin). Script supports dry run mode and --fix flag."
    },
    {
      "id": "CTB-006",
      "title": "Fix room-based furniture/decor mods",
      "description": "Add room themes to furniture and decor mods that have room keywords in title",
      "acceptanceCriteria": [
        "Create scripts/ralph/ctb-006-fix-room-themes.ts",
        "Find mods with 'bathroom' in title - add 'bathroom' to themes",
        "Find mods with 'kitchen' in title - add 'kitchen' to themes",
        "Find mods with 'bedroom' in title - add 'bedroom' to themes",
        "Find mods with 'living room' in title - add 'living-room' to themes",
        "Find mods with 'dining' in title - add 'dining-room' to themes",
        "Find mods with 'office' or 'study' in title - add 'office' to themes",
        "Find mods with 'kids' or 'child' room in title - add 'kids-room' to themes",
        "Find mods with 'nursery' or 'baby' room in title - add 'nursery' to themes",
        "Do NOT duplicate existing themes",
        "Dry run first, apply with --fix flag",
        "npm run type-check passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Completed 2026-01-24. Created scripts/ralph/ctb-006-fix-room-themes.ts using detectRoomThemes() from contentTypeDetector. Processed 10,447 mods in batches of 1,000 (to avoid Prisma Accelerate 5MB response limit). Added room themes to 764 mods: bathroom (115), kitchen (90), bedroom (144), living-room (255), dining-room (29), office (52), kids-room (20), nursery (28), outdoor (92). Script does not duplicate existing themes and supports dry run mode with --fix flag to apply."
    },
    {
      "id": "CTB-007",
      "title": "Fix NULL contentType mods",
      "description": "Analyze and categorize the 45 mods with NULL contentType",
      "acceptanceCriteria": [
        "Create scripts/ralph/ctb-007-fix-null-content.ts",
        "Query all mods where contentType IS NULL",
        "Run each through detectContentType function",
        "For mods where detection returns undefined, log for manual review",
        "For mods with confident detection, update contentType",
        "Create report of mods that couldn't be auto-categorized",
        "Dry run first, apply with --fix flag",
        "npm run type-check passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Completed 2026-01-24. Found 45 mods with NULL contentType, auto-fixed 22 with confident detection (accessories: 1, eyebrows: 2, full-body: 6, gameplay-mod: 1, hair: 6, jewelry: 1, lot: 3, pet-accessories: 1, preset: 1). 23 mods remain for manual review (generic CC packs, Sim characters, and ambiguous content). Report saved to ctb-007-null-content-report.txt."
    },
    {
      "id": "CTB-008",
      "title": "Validate accessory vs furniture categorization",
      "description": "Many furniture items are miscategorized as accessories - fix these",
      "acceptanceCriteria": [
        "Create scripts/ralph/ctb-008-fix-accessories.ts",
        "Find mods categorized as 'accessories' with furniture keywords: sink, toilet, shower, tub, sofa, couch, table, chair, desk, bed, shelf, cabinet",
        "Recategorize as appropriate furniture/decor type",
        "Find actual accessories miscategorized: bags, scarves, belts, watches, purses",
        "Ensure jewelry stays as jewelry not accessories",
        "Dry run first, apply with --fix flag",
        "npm run type-check passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Completed 2026-01-24. Created scripts/ralph/ctb-008-fix-accessories.ts with word-boundary matching and negative keyword filtering to prevent false positives. Fixed 31 mods: 5 furniture items in accessories (bathroom showers/toilets), 10 decor items in accessories (plants, paintings, posters, pillow), 3 jewelry items in accessories (rings, bracelets, necklaces), 8 true accessories in wrong categories (belts, tights, socks, gloves in tops/skin/glasses), 5 jewelry items in wrong categories (earrings/piercings in makeup/gameplay-mod). Uses contentTypeDetector for confident detection and skips lots/CC packs that mention furniture contextually."
    },
    {
      "id": "CTB-009",
      "title": "Full database validation pass",
      "description": "Run validation across entire database to find remaining mismatches",
      "acceptanceCriteria": [
        "Create scripts/ralph/ctb-009-full-validation.ts",
        "For each mod, compare contentType vs detectContentType result",
        "Flag mods where detection differs from stored value with high confidence",
        "Generate report of potential mismatches for review",
        "Report should include mod ID, title, current contentType, suggested contentType, confidence",
        "Output to scripts/ralph/ctb-validation-report.txt",
        "npm run type-check passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Completed 2026-01-24. Validated 10,447 mods: 4,559 match detection (49% match rate), 444 high-confidence mismatches, 4,298 medium-confidence. 23 NULL contentTypes remain (down from 45, 49% reduction). Before/After: Fixed original 4 orphaned types (preset, loading-screen, cas-background, pet-furniture), but 2 new orphans emerged (wall-art: 2 mods, pet-accessories: 1 mod - need FacetDefinitions). High-confidence mismatches include: skin->preset (54), makeup->lipstick (48), makeup->eyeliner (40), makeup->lashes (28) - these reflect the granular face type strategy. 23 mods require manual review (CC packs, Sim characters, generic content). Report saved to ctb-validation-report.txt."
    },
    {
      "id": "CTB-010",
      "title": "Final statistics and verification",
      "description": "Generate final statistics showing improved categorization coverage",
      "acceptanceCriteria": [
        "Create scripts/ralph/ctb-010-final-stats.ts",
        "Count mods per contentType (before vs after comparison)",
        "Count mods with NULL contentType (should be 0 or near 0)",
        "Count FacetDefinitions vs content types in use (should match)",
        "Verify all content types have corresponding FacetDefinitions",
        "Output summary to scripts/ralph/ctb-final-report.txt",
        "npm run type-check passes",
        "npm run build succeeds"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    }
  ]
}
