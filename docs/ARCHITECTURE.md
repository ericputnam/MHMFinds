# Architecture

## Project Overview

ModVault (MHMFinds) is a Sims mod discovery platform built with Next.js 14, TypeScript, Prisma, and PostgreSQL. The platform aggregates content from multiple sources (CurseForge, Patreon, Tumblr, etc.) and uses AI-powered search with OpenAI embeddings for semantic mod discovery.

---

## Directory Structure

### `/app` - Next.js 14 App Router

- `/api` - REST endpoints
  - `/api/auth/[...nextauth]` - NextAuth.js authentication handler
  - `/api/mods` - Mod CRUD endpoints
  - `/api/admin/*` - Admin-only routes (defense-in-depth auth)
- `/mods/[id]` - Dynamic mod detail pages
- `/games/[game]` - Game-specific browse pages with full search, facets, sort, and pagination

### `/lib` - Core Business Logic

- `/services` - Service layer
  - `contentAggregator.ts` - Standard web scraping (CurseForge, Patreon) via cheerio/axios
  - `privacyAggregator.ts` - Privacy-enhanced scraping with proxy rotation, user agent spoofing, and request timing randomization
  - `aiSearch.ts` - OpenAI-powered semantic search, recommendations, and mod similarity
- `/config` - Configuration files
  - `privacy.ts` - Privacy settings for content aggregation (default/stealth/conservative modes)
- `prisma.ts` - Prisma client singleton instance (with Accelerate extension support)
- `api.ts` - API client utilities
- `gameColors.ts` - Game-specific colors and taglines (single source of truth)
- `gameRoutes.ts` - Game slug mappings and SEO metadata

### `/components` - React Components

Hero, ModCard, SearchBar, Navbar, Footer, FacetedSidebar, ModGrid, and other landing page and browse components.

### `/prisma` - Database Schema and Migrations

- `schema.prisma` - Prisma schema defining all models

### `/scripts` - Standalone Utility Scripts

- `/scripts/compound/` - Automated compound system (nightly review and improvement pipeline)
- `/scripts/staging/` - WordPress deployment pull/push scripts for staging and production
- `/scripts/archive/` - Completed one-time scripts preserved for reference
- `/scripts/lib/` - Shared script utilities (e.g., `setup-env.ts` for Prisma script env setup)

### `/newapp` - Design Reference ONLY

Vite/React app using Tailwind CSS v4 and `motion` library. Generated by Google AI Studio. Used exclusively for visual design inspiration. Do NOT run, start, or migrate this app. Main development happens in the root Next.js project.

### `/staging` - WordPress Theme Snapshots

- `staging/wordpress/kadence-child/` - Staging server snapshot
- `staging/wordpress/kadence-child-prod/` - Production server snapshot

### `/tasks` - PRDs for Planned Work

- `tasks/prd-gsc-seo-cleanup/` - SEO cleanup PRDs driven by Google Search Console data
- `tasks/prd-compound/` - Auto-generated PRDs from the compound system

### `/docs` - Project Documentation

---

## Key Architecture Patterns

### Authentication

NextAuth.js with JWT strategy. Google and Discord OAuth providers. User sessions stored in PostgreSQL via Prisma adapter. Custom callbacks populate JWT with user metadata (`isCreator`, `isPremium`, `isAdmin`). A default "Favorites" collection is automatically created on user signup via an event handler.

### Database

PostgreSQL accessed through Prisma ORM. All models use `cuid()` IDs. Key models:

- **User** - User accounts with creator/premium/admin flags
- **Mod** - Central mod entity with rich metadata, creator relations, and search index
- **CreatorProfile** - Creator profiles linked to users
- **SearchIndex** - Stores OpenAI embeddings (`Float[]`) and full-text vectors for AI search
- **ContentSource** and **ScrapingJob** - Track content aggregation sources and jobs

Schema considerations:
- Mod prices use `Decimal(10,2)` - always coerce to `Number()` before formatting
- `SearchIndex.embedding` is `Float[]` for OpenAI embeddings
- All cascade deletes are configured (User deletion cascades to all related entities)
- Unique constraints on favorites, reviews, and collection items prevent duplicates

### Content Aggregation

Two implementations:

1. **`contentAggregator.ts`** - Basic scraping with cheerio/axios
2. **`privacyAggregator.ts`** - Advanced scraping with proxy rotation, user agent spoofing, request timing randomization, and session management

Privacy levels:
- **Default** - 3-8s delays, user agent rotation
- **Stealth** - 5-15s delays, proxy rotation, geographic rotation
- **Conservative** - 10-30s delays, strictest rate limiting

### AI Search

OpenAI embeddings (`text-embedding-3-small`) stored in `SearchIndex.embedding`. The `AISearchService` provides:

- Semantic search with cosine similarity
- User-personalized recommendations based on favorites/downloads
- Similar mod discovery
- Popularity boost formula: `log10((downloads + 1) * (favorites + 1) * (rating || 1)) * 0.1`

Embeddings are generated on-demand (no pre-computed cache). Results are filtered before embedding calculation (`limit * 2`), and cosine similarity is calculated in-memory.

### Multi-Game Support

- Game configuration centralized in `lib/gameColors.ts` (colors, taglines) and `lib/gameRoutes.ts` (slug mappings, SEO metadata)
- Homepage is game-agnostic (no default game filter, shows all games)
- Game-specific browse pages at `/games/[game]` with full search, facets, sort, and pagination
- Navbar dropdown auto-populates from `GAME_COLORS`
- Animal Crossing is pre-configured but not yet live

### WordPress Proxy

Blog content is served from a separate WordPress instance (`blog.musthavemods.com`) and proxied through the Next.js app:

- **Static assets** (`/wp-content/*`, `/wp-includes/*`) - Proxied via `vercel.json` edge rewrites (fast, no transformation needed)
- **HTML routes** (`/blog/*`, `/category/*`, `/tag/*`, date permalinks, catch-all) - Proxied through Next.js middleware for canonical URL rewriting, noindex stripping, and domain normalization
- Use `<a href>` (not `<Link>`) for WordPress-proxied routes in the Next.js app

### Path Aliases

TypeScript configured with `@/*` pointing to project root (see `tsconfig.json`).

---

## Admin API Security

Defense-in-depth with two layers:

1. **Middleware** (`middleware.ts`) - Blocks all `/api/admin/*` requests without admin auth at the request level
2. **Route-level auth** - Each handler calls `requireAdmin(request)` independently

Required pattern for all admin API routes:

```typescript
export const dynamic = 'force-dynamic';

export async function GET(request: NextRequest) {
  const auth = await requireAdmin(request);
  if (!auth.authorized) {
    return auth.response;
  }
  // ... handler logic
}
```

Run `npm run security:check-admin-auth` to verify all admin routes have proper auth before committing changes.

---

## Image Domains

Approved external image domains in `next.config.js`:

- The Sims Resource
- SimsDom
- Sims4Studio
- Patreon CDN
- CurseForge
- Tumblr
- Unsplash
- Placeholder

Add new domains to the `images.domains` array before using them in `next/image` components.

---

## Environment Variables

Required for development (see `env.example`):

| Variable | Purpose |
|---|---|
| `DATABASE_URL` | Prisma Accelerate URL (`prisma+postgres://...`) - enables query caching |
| `DIRECT_DATABASE_URL` | Direct PostgreSQL connection (`postgres://...`) - used for migrations and scripts |
| `NEXTAUTH_SECRET` | NextAuth.js secret for JWT signing |
| `NEXTAUTH_URL` | Application URL (`http://localhost:3000` in dev) |
| `OPENAI_API_KEY` | Required for AI search features |
| `CURSEFORGE_API_KEY` | Required for CurseForge content aggregation |
| `GOOGLE_CLIENT_ID` / `GOOGLE_CLIENT_SECRET` | Google OAuth |
| `DISCORD_CLIENT_ID` / `DISCORD_CLIENT_SECRET` | Discord OAuth |

`DATABASE_URL` should be the Accelerate URL (starts with `prisma+postgres://`) for caching. `DIRECT_DATABASE_URL` should be the direct postgres connection for migrations. Swapping these silently disables caching.

---

## Prisma Connection Pooling

On Vercel (serverless), each function invocation can create a new PrismaClient instance. The client must be cached globally to prevent connection pool exhaustion.

```typescript
// lib/prisma.ts - Critical singleton pattern
const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma =
  globalForPrisma.prisma ??
  new PrismaClient({ /* ... */ });

// Cache in ALL environments including production
if (!globalForPrisma.prisma) {
  globalForPrisma.prisma = prisma;
}
```

Prisma Accelerate (`@prisma/extension-accelerate`) is enabled when `DATABASE_URL` starts with `prisma://` or `prisma+postgres://`, providing query-level caching via `cacheStrategy`.
